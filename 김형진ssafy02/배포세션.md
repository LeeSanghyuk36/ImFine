# [도커 설치](#도커-설치)

# [Dockerfile](#Dockerfile)

# [docker-compose.yml](#docker-compose.yml)

# [젠킨스 이미지 생성 및 컨테이너 실행](#젠킨스-이미지-생성-및-컨테이너-실행)

# [젠킨스 비밀번호 확인](#젠킨스-비밀번호-확인)

# [젠킨스 파이프라인](#젠킨스-파이프라인)

# [FastAPI DockerFile](#FastAPI-DockerFile)



# 도커 설치

```
$ sudo apt install ca-certificates curl gnupg lsb-release -y
$ sudo mkdir -p /etc/apt/keyrings
$ curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
$ echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
$ sudo apt update
$ sudo apt install docker-ce docker-ce-cli containerd.io docker-compose docker-compose-plugin

```

# Dockerfile

```
FROM jenkins/jenkins:latest

ENV DEBIAN_FRONTEND noninteractive
ENV DEBCONF_NOWARNINGS="yes"

USER root
RUN apt-get -y update && apt-get install -y --no-install-recommends \
    vim \
    apt-utils
RUN apt-get install ca-certificates curl gnupg lsb-release -y
RUN mkdir -p /etc/apt/keyrings
RUN curl -fsSL https://download.docker.com/linux/debian/gpg | gpg --dearmor -o /etc/apt/keyrings/docker.gpg
RUN echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/debian $(lsb_release -cs) stable" | tee /etc/apt/sources.list.d/docker.list > /dev/null
RUN apt-get -y update
RUN apt-get install docker-ce docker-ce-cli containerd.io docker-compose docker-compose-plugin -y
RUN if [ -e /var/run/docker.sock ]; then chown jenkins:jenkins /var/run/docker.sock; fi
RUN usermod -aG docker jenkins
USER jenkins
```

# docker-compose.yml

```
version: "3.1"
services:
  jenkins:
    container_name: jenkins
    image: jenkins
    ports:
      - 50000:8080
      - 50001:50000
    volumes:
      - ~/jenkins:/var/jenkins_home
      - /var/run/docker.sock:/var/run/docker.sock
    restart: always
```

# 젠킨스 이미지 생성 및 컨테이너 실행

```
$ mkdir -p ~/jenkins
$ sudo chmod 777 ~/jenkins
$ docker build --no-cache -t jenkins . && \
   docker-compose up -d
```

# 젠킨스 비밀번호 확인

```
$ docker logs jenkins
```

# 젠킨스 파이프라인

```
pipeline {
    agent any
    
    environment {
        // Docker 이미지 이름 및 태그를 정의합니다.
        DOCKER_IMAGE = 'fastapi'
    }
    
    stages {
        stage('Clone Repository') {
            steps {
                script {
                    git branch: 'master', credentialsId: 'github-access-token', url: 'https://lab.ssafy.com/s09-final/S09P31D109.git'
                }
            }
        }
        
        stage('Build Image') {
             steps {
                // 이미지 빌드
                sh "docker build -t fastapi ${pwd()}/finetune-back"  
            }
        }
        
        stage('Deploy') {
            steps {
                // 이미 컨테이너가 존재하면 내린다
                // sh "docker rm -f ${DOCKER_IMAGE}"
                // docker ps 명령을 사용하여 fastapi 컨테이너가 실행 중인지 확인
                script{
                    def containerExists = sh(script: "docker ps -a --filter 'name=fastapi' --format '{{.Names}}' | grep fastapi", returnStatus: true)
                    if (containerExists == 0) {
                        sh "docker rm -f fastapi"
                    }    
                
                    // 컨테이너를 실행시킨다
                    sh "docker run --name ${DOCKER_IMAGE} -d -p 8000:80 ${DOCKER_IMAGE}"
                }
                
            }
        }
        
    }
}

```

# FastAPI DockerFile

```
FROM python:3.8

COPY ./src /src
WORKDIR /src

RUN pip install -r requirements.txt

EXPOSE 80

CMD ["uvicorn", "main:app", "--host", "0.0.0.0", "--port", "80"]
```